#!/usr/bin/env python

import csv
import requests
import json

def read_csv(file_name):
	''' This function read the data by raws in csv, into a list '''
	with open(file_name, 'rb') as f:
		reader = csv.reader(f)
		list_output = list(reader)
	# To get rid of the first raw, if it is the title from mongo export
	if list_output[0][0] == '_id':
		list_output = list_output[1:]

	return list_output


def get_geo_from_ip(list_ip):
	''' Use the API to get geo info for each IP, store them into list
	Input: a list of IP
	Return: a list contains all dict element return by API for each IP'''
	L = []
	prefix = 'http://api.db-ip.com/v2/free/'
	for ip in list_ip:
	#	ip = '184.22.218.93'
		url = prefix + str(ip)
		print url
		r = requests.get(url).text
		try:
			r_dict = json.loads(r)
		except:
			print 'Fail to convert r to r_dict, r is %s' %r
		L.append(r_dict)
	return L

def get_geo_multiple_ip(list_ip):
	'''To call API only once, with all the IP in the list argument'''
	prefix = 'http://api.db-ip.com/v2/free/'
	string_ip = ','.join(list_ip)
	#print string_ip
	url = prefix + string_ip
	r = requests.get(url).text
	try:
		r_dict = json.loads(r)
	except:
		print 'Fail to convert r to r_dict, r is %s' %r
	print r_dict

def filter_only_ID_IP(L_json):
	L_id_json = []
	for i in L_json:
		if i['countryCode'] == 'ID':
			L_id_json.append(i)
	print 'there are %s sets of data collected' %len(L_id_json)
	return L_id_json

def main():
	list_all = read_csv('10_lines.csv')
	#print list_all

	# Get IP 
	## But this step de-couple the ip with the original record, so is only for test.
	## In final application, may record the index for which line, or use list_all[i][4] directly
	list_ip = [i[4] for i in list_all]
	L_json = get_geo_from_ip(list_ip)

	#print L_json
	L_id = filter_only_ID_IP(L_json)
	print L_id



if __name__ == '__main__':
	main()


'''
SG IP:
['155.69.160.78', '188.166.210.231', '124.246.65.79', '27.104.248.13', '103.252.203.138', '222.164.39.175', '121.6.194.139', '111.65.44.74', '121.7.215.2', '119.56.111.211', '101.127.16.102', '58.182.44.12', '58.182.250.19', '155.69.16.255', '42.60.43.104', '188.166.227.69', '119.56.108.31', '178.128.16.187', '119.74.233.97', '175.156.21.161', '121.6.155.132', '175.156.52.129', '111.223.103.132', '209.97.172.6', '218.212.95.252', '61.47.105.131', '175.156.7.223', '116.14.192.80', '183.90.100.73', '132.147.81.214', '103.252.201.188', '121.6.143.44', '58.182.49.202', '116.12.204.157', '103.254.155.15', '27.104.204.229', '121.7.38.115', '175.156.54.144', '27.125.188.34', '138.75.220.34', '58.182.3.168', '219.75.43.191', '219.74.53.89', '119.74.98.199', '68.183.182.199', '42.60.41.131', '111.221.45.20', '116.251.211.181']

MY IP:
['219.92.10.143', '175.139.166.200', '147.158.64.230', '183.171.74.164', '118.100.164.141', '218.208.8.94', '14.192.210.211', '210.195.55.1', '115.134.150.6', '123.136.106.107', '118.101.48.11', '60.53.140.50', '175.140.188.86', '218.111.17.202', '60.51.49.102', '42.189.58.182', '103.38.194.60', '175.139.14.26', '192.228.203.93', '42.189.59.115', '175.145.118.36', '175.143.176.237', '121.122.59.36', '210.186.189.79', '175.139.205.97', '103.18.0.34', '175.140.235.135', '115.132.12.13', '42.190.161.183', '192.228.210.77', '161.142.3.132', '42.189.73.30', '175.143.188.164', '42.190.125.230', '115.132.190.176', '14.1.225.200', '115.132.208.172', '115.164.214.176', '115.134.20.202', '113.210.54.121', '175.141.148.201', '175.143.92.199', '123.136.118.243', '42.188.125.135', '175.141.241.195', '42.191.178.167', '60.52.110.78', '60.53.134.56', '210.195.148.162', '123.136.115.208', '60.53.243.100', '115.132.177.122', '115.132.47.55', '175.136.62.254', '110.159.176.1', '115.164.203.67', '175.136.211.172', '175.138.54.19', '175.141.161.68', '14.192.210.12', '118.101.137.60', '115.132.56.191', '123.136.106.2', '175.144.86.78', '202.184.108.93', '183.171.16.240', '219.92.10.62', '203.106.56.142', '1.32.69.48', '175.141.16.199', '210.187.189.219', '210.187.168.144', '175.141.102.21', '175.136.185.228', '42.190.210.130', '175.140.235.210', '61.6.122.55', '123.136.106.163', '115.164.177.62', '218.208.8.99', '161.142.47.118', '175.145.202.182', '210.195.58.206', '192.228.238.155', '175.140.229.74', '42.188.166.18', '183.171.77.228', '175.143.181.98', '60.54.44.103', '14.192.210.20', '61.6.8.106', '175.137.58.47', '175.145.111.132', '115.164.56.213', '14.192.210.168', '61.6.127.45', '42.191.132.100', '192.228.189.189', '175.136.0.99', '123.136.106.177', '60.53.41.100', '175.138.159.100', '42.153.135.131', '14.192.212.58', '118.100.103.161', '175.139.166.42', '183.171.69.18', '210.187.216.113', '42.189.100.238', '175.140.106.35', '219.92.117.141', '124.13.243.207', '14.1.225.164', '175.141.121.144', '14.192.210.71', '123.136.118.94', '175.142.84.10', '60.54.71.196', '42.188.17.184', '118.100.102.210', '115.133.108.114', '161.142.4.200', '42.190.20.7', '123.136.112.237', '110.159.94.81', '61.6.171.113', '175.138.52.231', '60.53.195.211', '115.133.100.166', '42.190.160.24', '42.190.245.139', '115.134.189.30', '1.32.68.182', '175.144.41.213', '118.100.87.177', '60.50.141.1', '115.164.212.15', '175.137.113.230', '115.164.52.215', '202.184.159.254', '42.188.30.207', '175.143.92.151', '42.190.221.44', '124.13.239.129', '175.144.93.135', '219.92.234.140', '115.132.34.89', '219.92.163.4', '175.141.223.158', '219.92.148.220', '115.133.121.134', '210.195.80.234', '42.190.147.120', '60.52.244.38', '118.100.213.122', '115.164.55.180', '60.53.67.153', '42.153.131.32', '175.138.53.215', '183.171.126.59', '118.100.183.239', '118.100.166.91', '175.142.95.157', '210.195.155.219', '121.122.89.107', '60.54.89.142', '175.142.249.76', '192.228.129.208', '183.171.74.117', '1.32.1.39', '203.135.190.53', '42.189.240.43', '42.191.39.130', '115.164.73.198', '183.171.76.117', '42.190.187.124', '42.189.78.39', '115.133.15.104', '14.192.210.129', '42.191.10.125', '123.136.111.83', '183.171.90.221', '115.132.47.73', '115.164.75.235']

